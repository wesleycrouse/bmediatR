---
title: "Replicating Simple Example"
author: "Madeleine S. Gastonguay"
output: 
   html_document:
    code_folding: show
    highlight: pygment
    theme: yeti
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: false
vignette: >
  %\VignetteIndexEntry{Replicating Simple Example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


## Load Packages and Set up environment
```{r}
# devtools::install_github("wesleycrouse/bmediatR@add-vignettes", build_vignettes = F)
library(bmediatR)
library(qtl2)
library(tidyverse)

source("bmediatr_manuscript_support_functions.R")

## CC colors
cc_col <- as.character(qtl2::CCcolors)

```

## Overview

In this vignette, we will recreate the illustrative example of bmediatR applied to QTL mapping with simulated Divesity Outbred (DO) mouse data shown in figure 5 of the [manuscript](https://www.biorxiv.org/content/10.1101/2021.07.19.452969v2).

## Simulate Data

For this example, we use genoprobs from 192 DO mice. We need to download them from the manuscript [figshare](https://figshare.com/articles/dataset/Data_and_code_for_Bayesian_model_selection_manuscript/14912484). This step will take a few minutes.

```{r}
id_data <- 14912484
download_url <- rfigshare::fs_details(id_data, mine = F, session = NULL)$files[[4]]$download_url
options(timeout = max(300, getOption("timeout")))
download.file(download_url, "vignette_data.RData.zip", method = "libcurl")
```

```{r}
load(unzip("vignette_data.RData.zip"))
```

### Non-mediator simulation
Simulate M and Y for non-mediator data:
```{r}
## set seed
set.seed(50)

null_m <- sim_mpp_data(genoprobs = genoprobs,
                       map = map,
                       qtl_effect_size = 0,
                       num_replicates = 1,
                       num_sim = 1,
                       vary_locus = TRUE,
                       sim_label = "null_m")
null_y <- sim_mpp_data(genoprobs = genoprobs,
                       map = map,
                       qtl_effect_size = 0.3,
                       num_replicates = 1,
                       num_sim = 1,
                       M_ID = "0,0,0,0,1,1,1,1",
                       beta = c(0, 1),
                       vary_locus = FALSE,
                       sim_label = "null_y",
                       impute = FALSE)

```

Genome scans for M and Y:
```{r}
null_m_scan <- scan1(genoprobs = genoprobs,
                     pheno = null_m$data,
                     kinship = K)
null_y_scan <- scan1(genoprobs = genoprobs,
                     pheno = null_y$data, 
                     kinship = K)
```

```{r, out.width="100%"}
plot_scan1(null_m_scan, map = map, 
           col = "black", altcol = "gray30", 
           bgcol = "white", altbgcol = "white",
           main = "No QTL for M",
           ylim = c(0, max(null_y_scan) + 1))
plot_scan1(null_y_scan, map = map, 
           col = "black", altcol = "gray30", 
           bgcol = "white", altbgcol = "white",
           main = "QTL for Y",
           ylim = c(0, max(null_y_scan) + 1))

```

Compare haplotype effects:
```{r}
## QTL effects for Y
null_y_qtl <- find_peaks(null_y_scan, map = map) %>%
  filter(lod == max(lod))
null_y_qtl <- calc_allele_effects_qtl2(qtl_table = null_y_qtl, 
                                       genoprobs = genoprobs, 
                                       phenotype_mat = null_y$data, 
                                       K = K, 
                                       map = map, 
                                       data.col = "lodcolumn")

## QTL effects for M
null_m_qtl <- find_peaks(null_y_scan, map = map) %>%
  filter(lod == max(lod))
null_m_qtl$lodcolumn <- colnames(null_m_scan)
null_m_qtl$lod <- null_m_scan[null_y_qtl$marker.id,]
null_m_qtl <- calc_allele_effects_qtl2(qtl_table = null_m_qtl, 
                                       genoprobs = genoprobs, 
                                       phenotype_mat = null_m$data, 
                                       K = K, 
                                       map = map, 
                                       data.col = "lodcolumn")

## Merging effects data
null_y_qtl_long <- null_y_qtl %>% 
  dplyr::select(LETTERS[1:8]) %>%
  gather(key = strain, value = y_effect) %>%
  inner_join(null_y_qtl %>%
               dplyr::select(paste(LETTERS[1:8], "SE", sep = "_")) %>%
               gather(key = strain, value = y_SE) %>%
               mutate(strain = gsub(strain, pattern = "_SE", replacement = "")))
null_m_qtl_long <- null_m_qtl %>% 
  dplyr::select(LETTERS[1:8]) %>%
  gather(key = strain, value = m_effect) %>%
  inner_join(null_m_qtl %>%
               dplyr::select(paste(LETTERS[1:8], "SE", sep = "_")) %>%
               gather(key = strain, value = m_SE) %>%
               mutate(strain = gsub(strain, pattern = "_SE", replacement = "")))
null_qtl_long <- inner_join(null_y_qtl_long, null_m_qtl_long)

## Plot
effects_w_ci_plot(null_qtl_long)
```


Apply bmediatR:
```{r}
null_y_qtl <- find_peaks(null_y_scan, map = map) %>%
  filter(lod == max(lod))

null_med_complete <- bmediatR(
  y = null_y$data, 
  M = null_m$data, 
  X = pull_genoprobpos(genoprobs = genoprobs, map = map, chr = null_y_qtl$chr, pos = null_y_qtl$pos),
  ln_prior_c = "complete"
)

## Plot
plot_posterior_bar(
  null_med_complete, 
  mediator_id = "null_m_1", 
  relabel_x = "M", 
  add_number_labels = TRUE, 
  num_dig = 2
)
```


### Co-local Simultaion
Simulate data:
```{r}
set.seed(100)
colocal <- sim_mpp_data(genoprobs = genoprobs,
                        map = map,
                        qtl_effect_size = 0.3,
                        num_replicates = 1,
                        num_sim = 2,
                        M_ID = "0,0,0,0,1,1,1,1",
                        beta = c(0, 1),
                        vary_locus = FALSE,
                        sim_label = "colocal_y",
                        impute = FALSE)
colocal_m <- colocal$data[,1, drop = FALSE]
colocal_y <- colocal$data[,2, drop = FALSE]
```

Genome scans for M and Y:
```{r}
colocal_m_scan <- scan1(genoprobs = genoprobs,
                        pheno = colocal_m,
                        kinship = K)
colocal_y_scan <- scan1(genoprobs = genoprobs,
                        pheno = colocal_y,
                        kinship = K)

```


```{r, out.width="100%"}
ymax <- max(c(max(colocal_m_scan), max(colocal_y_scan)) + 1)
plot_scan1(colocal_m_scan, map = map,
           col = "black", altcol = "gray30",
           bgcol = "white", altbgcol = "white",
           main = "No QTL for M",
           ylim = c(0, ymax))
plot_scan1(colocal_y_scan, map = map,
           col = "black", altcol = "gray30",
           bgcol = "white", altbgcol = "white",
           main = "QTL for Y",
           ylim = c(0, ymax))
```

Compare haplotype effects
```{r}
## QTL effects for Y
colocal_y_qtl <- find_peaks(colocal_y_scan, map = map) %>%
  filter(lod == max(lod))
colocal_y_qtl <- calc_allele_effects_qtl2(qtl_table = colocal_y_qtl,
                                          genoprobs = genoprobs,
                                          phenotype_mat = colocal_y,
                                          K = K,
                                          map = map,
                                          data.col = "lodcolumn")

## QTL effects for M
colocal_m_qtl <- find_peaks(colocal_m_scan, map = map) %>%
  filter(lod == max(lod))
colocal_m_qtl <- calc_allele_effects_qtl2(qtl_table = colocal_m_qtl,
                                          genoprobs = genoprobs,
                                          phenotype_mat = colocal_m,
                                          K = K,
                                          map = map,
                                          data.col = "lodcolumn")

## Merging effects data
colocal_y_qtl_long <- colocal_y_qtl %>%
  dplyr::select(LETTERS[1:8]) %>%
  gather(key = strain, value = y_effect) %>%
  inner_join(colocal_y_qtl %>%
               dplyr::select(paste(LETTERS[1:8], "SE", sep = "_")) %>%
               gather(key = strain, value = y_SE) %>%
               mutate(strain = gsub(strain, pattern = "_SE", replacement = "")))
colocal_m_qtl_long <- colocal_m_qtl %>%
  dplyr::select(LETTERS[1:8]) %>%
  gather(key = strain, value = m_effect) %>%
  inner_join(colocal_m_qtl %>%
               dplyr::select(paste(LETTERS[1:8], "SE", sep = "_")) %>%
               gather(key = strain, value = m_SE) %>%
               mutate(strain = gsub(strain, pattern = "_SE", replacement = "")))
colocal_qtl_long <- inner_join(colocal_y_qtl_long, colocal_m_qtl_long)

## Plot
effects_w_ci_plot(colocal_qtl_long)
```


Run mediation:
```{r}
colocal_y_qtl <- find_peaks(colocal_y_scan, map = map) %>%
  filter(lod == max(lod))

colocal_med_complete <- bmediatR(
  y = colocal_y,
  M = colocal_m,
  X = pull_genoprobpos(genoprobs = genoprobs, map = map, chr = colocal_y_qtl$chr, pos = colocal_y_qtl$pos),
  ln_prior_c = "complete"
)

## Plot
plot_posterior_bar(
  colocal_med_complete,
  mediator_id = "colocal_y_1",
  relabel_x = "M",
  add_number_labels = TRUE,
  num_dig = 2
)

```

### Complete Mediation Simulation
Simulate M and Y for complete mediation data:
```{r}
# set seed
set.seed(60)

complete_m <- sim_mpp_data(genoprobs = genoprobs,
                           map = map,
                           qtl_effect_size = 0.3,
                           num_replicates = 1,
                           num_sim = 1,
                           M_ID = "0,0,0,0,1,1,1,1",
                           beta = c(0, 1),
                           vary_locus = FALSE,
                           sim_label = "complete_m",
                           impute = FALSE)
complete_y <- sim_target_from_mediator(M = complete_m$data, mediator_effect_size = 0.7, sim_label = "complete_y")

```

Genome scans for M and Y:
```{r}
complete_m_scan <- scan1(genoprobs = genoprobs,
                         pheno = complete_m$data,
                         kinship = K)
complete_y_scan <- scan1(genoprobs = genoprobs,
                         pheno = complete_y$data,
                         kinship = K)
```

```{r, out.width="100%"}
ymax <- max(c(max(complete_m_scan), max(complete_y_scan)) + 1)
plot_scan1(complete_m_scan, map = map,
           col = "black", altcol = "gray30",
           bgcol = "white", altbgcol = "white",
           main = "QTL for M",
           ylim = c(0, ymax))
plot_scan1(complete_y_scan, map = map,
           col = "black", altcol = "gray30",
           bgcol = "white", altbgcol = "white",
           main = "QTL for Y",
           ylim = c(0, ymax))
```

Compare hapoltype effects


```{r}
complete_y_qtl <- find_peaks(complete_y_scan, map = map) %>%
  filter(lod == max(lod))
complete_y_qtl <- calc_allele_effects_qtl2(qtl_table = complete_y_qtl,
                                           genoprobs = genoprobs,
                                           phenotype_mat = complete_y$data,
                                           K = K,
                                           map = map,
                                           data.col = "lodcolumn")

## QTL effects for M
complete_m_qtl <- find_peaks(complete_m_scan, map = map) %>%
  filter(lod == max(lod))
complete_m_qtl <- calc_allele_effects_qtl2(qtl_table = complete_m_qtl,
                                           genoprobs = genoprobs,
                                           phenotype_mat = complete_m$data,
                                           K = K,
                                           map = map,
                                           data.col = "lodcolumn")

## Merging effects data
complete_y_qtl_long <- complete_y_qtl %>%
  dplyr::select(LETTERS[1:8]) %>%
  gather(key = strain, value = y_effect) %>%
  inner_join(complete_y_qtl %>%
               dplyr::select(paste(LETTERS[1:8], "SE", sep = "_")) %>%
               gather(key = strain, value = y_SE) %>%
               mutate(strain = gsub(strain, pattern = "_SE", replacement = "")))
complete_m_qtl_long <- complete_m_qtl %>%
  dplyr::select(LETTERS[1:8]) %>%
  gather(key = strain, value = m_effect) %>%
  inner_join(complete_m_qtl %>%
               dplyr::select(paste(LETTERS[1:8], "SE", sep = "_")) %>%
               gather(key = strain, value = m_SE) %>%
               mutate(strain = gsub(strain, pattern = "_SE", replacement = "")))
complete_qtl_long <- inner_join(complete_y_qtl_long, complete_m_qtl_long)

## Plot
effects_w_ci_plot(complete_qtl_long)

```



bmediatR mediation:
```{r}
complete_y_qtl <- find_peaks(complete_y_scan, map = map) %>%
  filter(lod == max(lod))

complete_med_complete <- bmediatR(
  y = complete_y$data,
  M = complete_m$data,
  X = pull_genoprobpos(genoprobs = genoprobs, map = map, chr = complete_y_qtl$chr, pos = complete_y_qtl$pos),
  ln_prior_c = "complete"
)

## Plot
plot_posterior_bar(
  complete_med_complete,
  mediator_id = "complete_m_1",
  relabel_x = "M",
  add_number_labels = TRUE,
  num_dig = 2
)
```

